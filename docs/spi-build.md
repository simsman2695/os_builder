Building a new SPI image for the RK3588 using the `rkbin` repository involves packaging the bootloader components (DDR initialization, SPL, and Trust/ATF) into a single binary file formatted specifically for SPI Flash memory.

As noted in the `rkbin` commit history, a tool called `firmwareMerger` is specifically updated for packing SPI images.

### 1. Requirements

* **The rkbin repository:** Cloned locally.
* **A Pre-built Loader:** Typically generated by `boot_merger` or downloaded as a `.bin` from the `bin/` directory.
* **U-Boot/Trust binaries:** Usually `u-boot.itb` or the `bl31.elf` and `spl.bin` files.

---

### 2. Method A: Using `boot_merger` (Standard Method)

The most common way to create an SPI-compatible loader is using the `boot_merger` tool with an `.ini` file that targets SPI.

1. **Navigate to the tools directory:**
```bash
cd rkbin/tools

```


2. **Locate the RK3588 SPI Configuration:**
Look for an `.ini` file in `RKBOOT/` that includes "SPI" or "MINIALL". For the RK3588, `RK3588MINIALL.ini` is often used as the base.
3. **Run the Tool:**
```bash
./boot_merger ../RKBOOT/RK3588MINIALL.ini

```


This generates a `rk3588_loader_vX.XX.bin`. This file is technically a "MiniLoader" and is often what is written to the start of the SPI flash.

---

### 3. Method B: Using `firmwareMerger` (Advanced SPI Packing)

If you need to create a complete SPI system image (including the actual U-Boot or complex partitions), use `firmwareMerger`.

1. **Prepare a configuration file (e.g., `spi_image.cfg`):**
You need a text file that describes the offsets for the SPI flash.
```text
# Example SPI Layout
[0x00000000] ../bin/rk35/rk3588_ddr_lp4_2112MHz_v1.11.bin
[0x00008000] ../bin/rk35/rk3588_spl_v1.xx.bin
[0x00040000] ../u-boot.itb

```


2. **Execute the Merger:**
```bash
./firmwareMerger -c spi_image.cfg spi_flash_image.img

```



---

### 4. Method C: The "Manual" dd Method (Mainline/Radxa Style)

If you already have a compiled `u-boot-rockchip.bin` (which you built using the `rkbin` environment variables), you can create an SPI image simply by ensuring the padding is correct.

Since SPI flash usually starts at sector 0 for the boot ROM, you can create a padded image:

```bash
# Create a 16MB blank image (typical SPI size)
dd if=/dev/zero of=spi_image.img bs=1M count=16

# Write the bootloader at the correct offset (usually 0 for SPI)
dd if=u-boot-rockchip.bin of=spi_image.img conv=notrunc

```

### 5. Flashing the SPI Image

Once the image is built, you can flash it from within the RK3588 (if running Linux) using `flashcp`:

```bash
# Install mtd-utils if needed
sudo apt install mtd-utils

# Identify the SPI device (usually /dev/mtd0)
sudo flash_erase /dev/mtd0 0 0
sudo flashcp -v spi_flash_image.img /dev/mtd0

```

### Summary Table: Offsets for SPI Flash

| Component | Offset (Hex) | Offset (Sector) |
| --- | --- | --- |
| **IDB (DDR + SPL)** | `0x00000000` | 0 |
| **U-Boot / Trust** | `0x00040000` | 512 |
| **Environment** | `0x003F0000` | â€” |
