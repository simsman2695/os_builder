#!/bin/bash
# set-hostname — generate unique hostname from primary NIC MAC address
# Runs once on first boot. Retries briefly if NIC isn't enumerated yet.

set -e

# Wait up to 15 seconds for an ethernet interface to appear
MAC=""
for attempt in $(seq 1 15); do
    for iface in /sys/class/net/en*; do
        [ -e "$iface" ] || continue
        MAC="$(cat "$iface/address" 2>/dev/null)" && break 2
    done
    echo "set-hostname: waiting for ethernet interface (attempt ${attempt}/15) ..." >&2
    sleep 1
done

if [ -z "$MAC" ]; then
    echo "set-hostname: no ethernet interface found after 15s, failing" >&2
    exit 1
fi

# Last 3 octets, stripped of colons → 6 hex chars
SUFFIX="$(echo "$MAC" | awk -F: '{print $(NF-2) $(NF-1) $NF}')"
NEW_HOSTNAME="cpedge-${SUFFIX}"

# Read current hostname
OLD_HOSTNAME="$(hostname)"

# Set it (write directly — hostnamectl needs D-Bus/polkit which may not be ready)
echo "$NEW_HOSTNAME" > /etc/hostname
hostname "$NEW_HOSTNAME"

# Update /etc/hosts
if grep -q "$OLD_HOSTNAME" /etc/hosts 2>/dev/null; then
    sed -i "s/$OLD_HOSTNAME/$NEW_HOSTNAME/g" /etc/hosts
else
    sed -i "s/^127\.0\.1\.1.*/127.0.1.1\t$NEW_HOSTNAME/" /etc/hosts
    grep -q "127.0.1.1" /etc/hosts || echo "127.0.1.1	$NEW_HOSTNAME" >> /etc/hosts
fi

echo "set-hostname: hostname set to $NEW_HOSTNAME (MAC: $MAC)"

# Mark done so we don't run again
touch /var/lib/set-hostname.done

# Disable ourselves — one-shot
systemctl disable set-hostname-firstboot.service 2>/dev/null || true
