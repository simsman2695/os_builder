# rk3588-virt.config — Kernel config fragment for KVM/QEMU/LXC virtualization
#
# Adds virtualization and container support configs that are NOT already
# enabled by arm64 defconfig. KVM core, VIRTIO basics, VFIO, bridging,
# namespaces, and cgroups are already in defconfig — this fragment adds
# VHOST acceleration, nftables, and container-specific extras.

# ── NVMe boot support (must be built-in for rootfs-on-NVMe without initramfs)
CONFIG_NVME_CORE=y
CONFIG_BLK_DEV_NVME=y

# ── VHOST acceleration (host-side virtio fast path) ────────────────────────
CONFIG_VHOST_NET=m
CONFIG_VHOST_VSOCK=m
CONFIG_VSOCKETS=m
CONFIG_VIRTIO_VSOCKETS_COMMON=m

# ── nftables (CRITICAL — 6.18 moved iptables filter/nat/mangle behind
# XTABLES_LEGACY; without nftables, no firewall/NAT rules work at all) ─────
CONFIG_NF_TABLES=m
CONFIG_NF_TABLES_INET=y
CONFIG_NFT_CT=m
CONFIG_NFT_NAT=m
CONFIG_NFT_MASQ=m
CONFIG_NFT_LOG=m
CONFIG_NFT_LIMIT=m
CONFIG_NFT_REJECT=m
CONFIG_NFT_REJECT_INET=m
CONFIG_NFT_COMPAT=m
CONFIG_NFT_FIB=m
CONFIG_NFT_FIB_INET=m
CONFIG_NFT_FIB_IPV4=m
CONFIG_NFT_FIB_IPV6=m
CONFIG_NFT_CONNLIMIT=m
CONFIG_NF_NAT=m

# ── Netfilter xt matches/targets for libvirt/LXC NAT networking ───────────
CONFIG_NETFILTER_XT_MATCH_COMMENT=m
CONFIG_NETFILTER_XT_MATCH_MULTIPORT=m
CONFIG_NETFILTER_XT_MATCH_CONNMARK=m
CONFIG_NETFILTER_XT_MATCH_PHYSDEV=m
CONFIG_NETFILTER_XT_MATCH_PKTTYPE=m
CONFIG_NETFILTER_XT_TARGET_MASQUERADE=m
CONFIG_NETFILTER_XT_TARGET_CT=m
CONFIG_NETFILTER_XT_TARGET_TCPMSS=m
CONFIG_NF_CT_NETLINK=m

# ── Extra networking for VMs/containers ────────────────────────────────────
CONFIG_DUMMY=m
CONFIG_IPVLAN=m

# ── Cgroups for container CPU/net limits ───────────────────────────────────
CONFIG_CFS_BANDWIDTH=y
CONFIG_CGROUP_NET_PRIO=y
CONFIG_CGROUP_NET_CLASSID=y
CONFIG_NET_CLS_CGROUP=m

# ── Container checkpoint/restore ──────────────────────────────────────────
CONFIG_CHECKPOINT_RESTORE=y

# ── VIRTIO devices for guest VMs ──────────────────────────────────────────
CONFIG_VIRTIO_INPUT=m
CONFIG_VIRTIO_FS=m
CONFIG_DRM_VIRTIO_GPU=m

# ── VFIO platform passthrough ─────────────────────────────────────────────
CONFIG_VFIO_PLATFORM=m
