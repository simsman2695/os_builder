From e26c91d4aa52657506a77e6bef8dc9176803b1a0 Mon Sep 17 00:00:00 2001
From: Daniel Almeida <daniel.almeida@collabora.com>
Date: Wed, 29 Oct 2025 17:37:16 -0300
Subject: [PATCH 150/161] tyr: support the vm_get_state ioctl

---
 drivers/gpu/drm/tyr/file.rs | 19 ++++++++++++++++---
 1 file changed, 16 insertions(+), 3 deletions(-)

diff --git a/drivers/gpu/drm/tyr/file.rs b/drivers/gpu/drm/tyr/file.rs
index 07a8bef50a..f5b570f19c 100644
--- a/drivers/gpu/drm/tyr/file.rs
+++ b/drivers/gpu/drm/tyr/file.rs
@@ -418,10 +418,23 @@ pub(crate) fn vm_bind(
 
     pub(crate) fn vm_get_state(
         _tdev: &TyrDevice,
-        _vmgetstate: &mut uapi::drm_panthor_vm_get_state,
-        _file: &DrmFile,
+        vmgetstate: &mut uapi::drm_panthor_vm_get_state,
+        file: &DrmFile,
     ) -> Result<u32> {
-        Err(ENOTSUPP)
+        let vm = file
+            .inner()
+            .vm_pool()
+            .get_vm(vmgetstate.vm_id as usize)
+            .ok_or(EINVAL)?;
+
+        let vm = vm.lock();
+        vmgetstate.state = if vm.unusable {
+            uapi::drm_panthor_vm_state_DRM_PANTHOR_VM_STATE_UNUSABLE
+        } else {
+            uapi::drm_panthor_vm_state_DRM_PANTHOR_VM_STATE_USABLE
+        };
+
+        Ok(0)
     }
 
     pub(crate) fn bo_create(
-- 
2.51.0

