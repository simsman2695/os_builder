From 6b85b5adc712325fa01bbca65ceaf5c5b443cf3a Mon Sep 17 00:00:00 2001
From: Alice Ryhl <aliceryhl@google.com>
Date: Fri, 13 Jun 2025 09:31:00 +0000
Subject: [PATCH 088/161] tyr: mark groups idle on update

Signed-off-by: Alice Ryhl <aliceryhl@google.com>
---
 drivers/gpu/drm/tyr/sched/events.rs | 17 +++++++++++++++--
 1 file changed, 15 insertions(+), 2 deletions(-)

diff --git a/drivers/gpu/drm/tyr/sched/events.rs b/drivers/gpu/drm/tyr/sched/events.rs
index d7ddc609e1..79e95b67a4 100644
--- a/drivers/gpu/drm/tyr/sched/events.rs
+++ b/drivers/gpu/drm/tyr/sched/events.rs
@@ -198,7 +198,9 @@ pub(crate) fn set_events(&mut self, tdev: &TyrDevice, events: u32) {
         }
     }
 
-    fn update_group(&mut self, group: &Group) -> Result {
+    fn update_group(&mut self, group: Arc<Group>, data: &TyrData) -> Result {
+        let mut no_in_flight_jobs = true;
+
         // TODO: we need to annotate this function with the dma signalling token.
         // TODO: we cannot sleep in the signalling path.
         group.with_locked_inner(|inner| {
@@ -229,11 +231,22 @@ fn update_group(&mut self, group: &Group) -> Result {
                     false
                 });
                 res?;
+
+                no_in_flight_jobs &= queue.in_flight_jobs.is_empty();
             }
 
             Ok(())
         })?;
 
+        if no_in_flight_jobs {
+            self.mark_group_idle(group, data)?;
+        }
+
+        Ok(())
+    }
+
+    fn mark_group_idle(&mut self, group: Arc<Group>, data: &TyrData) -> Result {
+        self.idle_groups[group.priority as usize].push(group, GFP_KERNEL)?;
         Ok(())
     }
 }
@@ -268,7 +281,7 @@ impl WorkItem<3> for TyrData {
     fn run(this: Self::Pointer) {
         let _ = this.with_locked_scheduler(|sched| {
             while let Some(group) = sched.unsynced_groups.pop() {
-                sched.update_group(&group).inspect_err(|e| {
+                sched.update_group(group, &this).inspect_err(|e| {
                     pr_err!("Failed to process firmware events: {}", e.to_errno());
                 })?;
             }
-- 
2.51.0

