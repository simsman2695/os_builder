From 15357285c56903de7d7802ea58206f1690b7de8f Mon Sep 17 00:00:00 2001
From: Daniel Almeida <daniel.almeida@collabora.com>
Date: Mon, 27 Oct 2025 10:33:50 -0300
Subject: [PATCH 126/161] tyr: set maximum opp

We don't have any power management code at the moment, so a sensible
default is to choose the maximum clock/voltage configuration.

The device will be at its maximum performance point at all times (even
when the workload doesn't require it) but at least we can use it for
testing and benchmarks.
---
 drivers/gpu/drm/tyr/driver.rs | 53 +++++++++++++++++++++++++++++++++++
 1 file changed, 53 insertions(+)

diff --git a/drivers/gpu/drm/tyr/driver.rs b/drivers/gpu/drm/tyr/driver.rs
index 044f9557ad..c4bb6311cd 100644
--- a/drivers/gpu/drm/tyr/driver.rs
+++ b/drivers/gpu/drm/tyr/driver.rs
@@ -22,6 +22,7 @@
 use kernel::new_mutex;
 use kernel::new_work;
 use kernel::of;
+use kernel::opp;
 use kernel::platform;
 use kernel::prelude::*;
 use kernel::regulator;
@@ -168,6 +169,53 @@ fn issue_soft_reset(iomem: &Devres<IoMem<0>>) -> Result<()> {
     Ok(())
 }
 
+fn set_maximum_opp(pdev: &ARef<platform::Device>) {
+    match opp::Table::from_of(&pdev.as_ref().into(), 0) {
+        Ok(table) => {
+            match table.opp_from_freq(
+                kernel::clk::Hertz(kernel::ffi::c_ulong::MAX),
+                Some(true), // Only consider available (enabled) OPPs
+                None,       // Use default clock index (0)
+                opp::SearchType::Floor,
+            ) {
+                Ok(max_opp) => {
+                    let freq = max_opp.freq(None);
+                    let voltage = max_opp.voltage();
+
+                    dev_info!(
+                        pdev.as_ref(),
+                        "Setting GPU to max performance: {} Hz @ {} uV\n",
+                        kernel::ffi::c_ulong::from(freq),
+                        kernel::ffi::c_ulong::from(voltage)
+                    );
+
+                    if let Err(e) = table.set_opp(&max_opp) {
+                        dev_warn!(
+                            pdev.as_ref(),
+                            "Failed to set max OPP: {:?}, continuing anyway\n",
+                            e
+                        );
+                    }
+                }
+                Err(e) => {
+                    dev_info!(
+                        pdev.as_ref(),
+                        "Failed to get max OPP: {:?}, using default clocks\n",
+                        e
+                    );
+                }
+            }
+        }
+        Err(e) => {
+            dev_info!(
+                pdev.as_ref(),
+                "No OPP table in device tree: {:?}, using default clocks\n",
+                e
+            );
+        }
+    }
+}
+
 kernel::of_device_table!(
     OF_TABLE,
     MODULE_OF_TABLE,
@@ -216,6 +264,11 @@ fn probe(
         }
         let platform: ARef<platform::Device> = pdev.into();
 
+        // Set GPU to maximum performance operating point
+        // This ensures the GPU runs at the highest frequency for best
+        // performance while we don't have any power management code in place.
+        set_maximum_opp(&platform);
+
         //TODO: This is very temporary
         // SAFETY: This should be safe as data is not touched by the driver
         // untill it gets fully initialised.
-- 
2.51.0

