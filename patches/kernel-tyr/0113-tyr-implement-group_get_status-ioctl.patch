From 6ce5849d0519f21f60f5a6d59ddf661e04e01905 Mon Sep 17 00:00:00 2001
From: Daniel Almeida <daniel.almeida@collabora.com>
Date: Thu, 16 Oct 2025 16:10:21 -0300
Subject: [PATCH 113/161] tyr: implement group_get_status ioctl

---
 drivers/gpu/drm/tyr/file.rs | 34 +++++++++++++++++++++++++++++++---
 1 file changed, 31 insertions(+), 3 deletions(-)

diff --git a/drivers/gpu/drm/tyr/file.rs b/drivers/gpu/drm/tyr/file.rs
index bc2b1a2cf1..1f58f5aecc 100644
--- a/drivers/gpu/drm/tyr/file.rs
+++ b/drivers/gpu/drm/tyr/file.rs
@@ -377,10 +377,38 @@ pub(crate) fn group_submit(
 
     pub(crate) fn group_get_state(
         _tdev: &TyrDevice,
-        _groupgetstate: &mut uapi::drm_panthor_group_get_state,
-        _file: &DrmFile,
+        groupgetstate: &mut uapi::drm_panthor_group_get_state,
+        file: &DrmFile,
     ) -> Result<u32> {
-        Err(ENOTSUPP)
+        if groupgetstate.pad != 0 {
+            return Err(EINVAL);
+        }
+
+        let group = file
+            .inner()
+            .group_pool()
+            .group(groupgetstate.group_handle as usize)
+            .ok_or(EINVAL)?;
+
+        // Clear the output fields first
+        groupgetstate.state = 0;
+        groupgetstate.fatal_queues = 0;
+
+        group.with_locked_inner(|inner| {
+            // Check for fatal queues
+            if inner.fatal_queues != 0 {
+                groupgetstate.state |=
+                    uapi::drm_panthor_group_state_flags_DRM_PANTHOR_GROUP_STATE_FATAL_FAULT;
+                groupgetstate.fatal_queues = inner.fatal_queues;
+            }
+
+            // TODO: Add support for timedout and innocent flags when tyr implements
+            // timeout tracking and reset handling similar to Panthor
+
+            Ok(())
+        })?;
+
+        Ok(0)
     }
 
     pub(crate) fn heap_create(
-- 
2.51.0

